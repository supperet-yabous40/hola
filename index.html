<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Epstein House 3D</title>
<style>
  body { margin:0; overflow:hidden; font-family:Arial, sans-serif; background:#111; color:white; }
  #overlay { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; background:rgba(0,0,0,0.8); z-index:10; }
  #overlay h1 { font-size:48px; margin:0; }
  #overlay p { margin:10px 0 30px 0; font-size:18px; }
  #overlay button { padding:10px 20px; margin:5px; font-size:18px; cursor:pointer; border-radius:10px; border:none; background:#e63946; color:white; transition:0.3s; }
  #overlay button:hover { background:#d62828; }
  canvas { display:block; }
</style>
</head>
<body>

<!-- شاشة البداية + اختيار الشخصية -->
<div id="overlay">
  <h1>Epstein House</h1>
  <p>This game developed by Abdou Zeraoulia</p>
  <div id="start-screen">
    <button onclick="showCharacterSelection()">ابدأ</button>
  </div>
  <div id="char-selection" style="display:none;">
    <p>اختر شخصيتك</p>
    <button onclick="selectPlayer(0)"><img src="assets/images/player1.png" width="50"> شخصية خضراء</button>
    <button onclick="selectPlayer(1)"><img src="assets/images/player2.png" width="50"> شخصية زرقاء</button>
    <button onclick="selectPlayer(2)"><img src="assets/images/player3.png" width="50"> شخصية صفراء</button>
  </div>
</div>

<!-- Joystick -->
<div id="joystick" style="position:absolute; bottom:20px; left:20px; width:120px; height:120px; z-index:5;"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>
<script>
let scene, camera, renderer;
let player, zombies = [];
let selectedPlayer = 0;
let move = {x:0,y:0};
let walkSound = new Audio('assets/sounds/walk.mp3');
let zombieSound = new Audio('assets/sounds/zombie.mp3');
let gameOverSound = new Audio('assets/sounds/gameover.mp3');

function showCharacterSelection(){
  document.getElementById("start-screen").style.display="none";
  document.getElementById("char-selection").style.display="block";
}

function selectPlayer(index){
  selectedPlayer = index;
  document.getElementById("overlay").style.display="none";
  initGame();
}

// ----- INIT GAME -----
function initGame(){
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x222222);

  camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.set(0,5,10);

  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  let light = new THREE.DirectionalLight(0xffffff,1);
  light.position.set(5,10,5);
  scene.add(light);

  // Floor
  let floorTexture = new THREE.TextureLoader().load('assets/images/floor.png');
  floorTexture.wrapS = floorTexture.wrapT = THREE.RepeatWrapping;
  floorTexture.repeat.set(10,10);
  let floor = new THREE.Mesh(
    new THREE.PlaneGeometry(20,20),
    new THREE.MeshPhongMaterial({map:floorTexture})
  );
  floor.rotation.x = -Math.PI/2;
  scene.add(floor);

  // Walls
  let wallTexture = new THREE.TextureLoader().load('assets/images/wall.png');
  let wallMaterial = new THREE.MeshPhongMaterial({map: wallTexture});
  let walls = [
    new THREE.Mesh(new THREE.BoxGeometry(20,5,0.5), wallMaterial),
    new THREE.Mesh(new THREE.BoxGeometry(20,5,0.5), wallMaterial),
    new THREE.Mesh(new THREE.BoxGeometry(0.5,5,20), wallMaterial),
    new THREE.Mesh(new THREE.BoxGeometry(0.5,5,20), wallMaterial)
  ];
  walls[0].position.set(0,2.5,-10);
  walls[1].position.set(0,2.5,10);
  walls[2].position.set(-10,2.5,0);
  walls[3].position.set(10,2.5,0);
  walls.forEach(w=>scene.add(w));

  // Player
  let colors = [0x00ff00,0x0000ff,0xffff00];
  let material = new THREE.MeshPhongMaterial({color: colors[selectedPlayer]});
  player = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), material);
  player.position.set(0,1,0);
  scene.add(player);

  // Zombies
  for(let i=0;i<3;i++){
    let z = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), new THREE.MeshPhongMaterial({color:0xff0000}));
    z.position.set(Math.random()*16-8,1,Math.random()*16-8);
    zombies.push(z);
    scene.add(z);
  }

  // Joystick
  let joystickManager = nipplejs.create({zone: document.getElementById('joystick'), mode:'static', position:{left:'60px', bottom:'60px'}});
  joystickManager.on('move', (evt, data)=>{
    if(data && data.distance>0){
      move.x = Math.cos(data.angle.radian)*0.1;
      move.z = Math.sin(data.angle.radian)*0.1;
      walkSound.currentTime=0; walkSound.play();
    }
  });
  joystickManager.on('end', ()=>{ move.x=0; move.z=0; });

  animate();
}

// ----- GAME LOOP -----
function animate(){
  requestAnimationFrame(animate);

  // Boundaries
  let minX = -9, maxX = 9, minZ = -9, maxZ = 9;
  let speed = 0.05; // أقل من قبل لتكون سلسة

  player.position.x += move.x*speed;
  player.position.z += move.z*speed;

  // حصر الحركة داخل الجدران
  player.position.x = Math.max(minX, Math.min(maxX, player.position.x));
  player.position.z = Math.max(minZ, Math.min(maxZ, player.position.z));

  // Zombies follow
  zombies.forEach(z=>{
    let dx = player.position.x - z.position.x;
    let dz = player.position.z - z.position.z;
    let dist = Math.sqrt(dx*dx+dz*dz);
    if(dist>0.1){
      z.position.x += (dx/dist)*0.02;
      z.position.z += (dz/dist)*0.02;
    }
    if(dist<1){ gameOver(); }
  });

  // Camera follow
  camera.position.x = player.position.x;
  camera.position.z = player.position.z + 10;
  camera.lookAt(player.position);

  renderer.render(scene, camera);
}

function gameOver(){
  alert("Game Over!");
  gameOverSound.play();
  location.reload();
}
</script>

</body>
</html>